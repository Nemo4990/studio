/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All sensitive user-specific data
 * is nested within that user's own document tree, ensuring that a user can only ever access their own information.
 * Publicly readable data is segregated into top-level collections with write access locked down.
 *
 * Data Structure: The data is organized hierarchically. A top-level `/users/{userId}` collection holds user profiles.
 * All related private data, such as deposits, withdrawals, and testimonials, are stored in subcollections
 * under the corresponding user's document (e.g., `/users/{userId}/deposits/{depositId}`). This structure makes
 * ownership-based security rules simple and performant. Public data (tasks) and platform-wide data (submissions)
 * reside in their own top-level collections.
 *
 * Key Security Decisions:
 * - User Enumeration Disabled: Listing documents in the top-level `/users` collection is disallowed to prevent exposing the user base, except for admins.
 * - Strict Ownership: All user-specific subcollections are strictly controlled. Only the authenticated user matching `{userId}` can read or write their own documents.
 * - Admin Access: An `isAdmin()` function, which checks for a `role == 'admin'` field on the user's profile, grants privileged access to read/write data across the platform, such as viewing all users or managing all submissions.
 * - Top-Level Submissions: The `/submissions` collection is at the top level to allow admins to query all submissions efficiently without running into collection group query limitations. User access is restricted to their own submissions via query constraints.
 * - Relational Integrity: On document creation, rules ensure that internal ID fields (like `userId`) match the document's path or the user's auth UID, creating a secure and consistent link.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if a document exists and if the requester is the owner.
     * Used for secure update and delete operations.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Checks if the current user has the 'admin' role by checking their email.
     * This is safe to use in list queries.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'admin@taskverse.io';
    }

    // -------------------------------------------------------------------------
    // Collection Rules
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profile documents.
     * @path /users/{userId}
     * @allow A user reads or updates their own profile. An admin can read any profile.
     * @deny Any non-admin user tries to list all users.
     */
    match /users/{userId} {
      allow get, update: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow delete: if false; // Deleting user accounts is a sensitive operation, disabled by default.
    }

    /**
     * @description Stores tasks that are publicly available on the platform.
     * @path /tasks/{taskId}
     * @allow Any user can read the list of tasks.
     * @deny Any client-side user tries to write to the tasks collection.
     */
    match /tasks/{taskId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Top-level collection for all task submissions.
     * @path /submissions/{submissionId}
     * @allow Admins can read all submissions. Users can read their own.
     * @allow Users can create their own submissions.
     */
    match /submissions/{submissionId} {
      allow read: if isAdmin() || isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Top-level collection for all deposit requests.
     * @path /deposits/{depositId}
     * @allow Admins can read all deposits. Users can read their own.
     * @allow Users can create their own deposits.
     */
    match /deposits/{depositId} {
      allow read: if isAdmin() || isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Top-level collection for all withdrawal requests.
     * @path /withdrawals/{withdrawalId}
     * @allow Admins can read all withdrawals. Users can read their own.
     * @allow Users can create their own withdrawals.
     */
    match /withdrawals/{withdrawalId} {
      allow read: if isAdmin() || isOwner(resource.data.userId);
      allow create: if isOwner(request.resource.data.userId);
      allow update, delete: if isAdmin();
    }

    /**
     * @description Stores payment agent information.
     * @path /agents/{agentId}
     * @allow Any authenticated user can read agents. Admins can manage them.
     */
    match /agents/{agentId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * @description Stores wallet information.
     * @path /wallets/{walletId}
     * @deny All operations are denied because the entity is missing an ownership field.
     */
    match /wallets/{walletId} {
      allow read, write: if false;
    }

    /**
     * @description Stores testimonials provided by a specific user.
     * @path /users/{userId}/testimonials/{testimonialId}
     * @allow A user can manage their own testimonials.
     * @deny A user cannot access another user's testimonials.
     */
    match /users/{userId}/testimonials/{testimonialId} {
      allow read, write: if isOwner(userId);
    }
  }
}
